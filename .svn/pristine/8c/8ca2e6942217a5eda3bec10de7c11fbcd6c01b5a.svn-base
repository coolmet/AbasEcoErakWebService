package com.abas.ecoerak.service.impl;

import java.util.ArrayList;
import org.apache.tomcat.util.json.JSONParser;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import com.abas.ecoerak.service.EdpService;
import com.abas.ecoerak.service.EdpSessionService;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.abas.ecoerak.service.AbasMobileUtils;
import de.abas.ceks.jedp.EDPEditor;
import de.abas.ceks.jedp.EDPMessage;
import de.abas.ceks.jedp.EDPSession;
import com.abas.ecoerak.SprinBootAppConfiguration;
import com.abas.ecoerak.model.ExecResult;
import com.abas.ecoerak.model.Master;

@Service
@Transactional(rollbackFor=Exception.class)
public class EdpServiceImpl implements EdpService
{
	@Autowired
	EdpSessionService edpSessionService;
	
	@Autowired
	AbasMobileUtils abasMobileUtils;
	
	Logger LOGGER=LoggerFactory.getLogger(SprinBootAppConfiguration.class);
	
	@Override
	public ExecResult addOrder(Master master)
	{
		ExecResult er=new ExecResult();
		try
		{
			er=this.addOrder(new ObjectMapper().writeValueAsString(master));
		}
		catch(Exception e)
		{
			er.setIsSuccess(false);
			er.setMessage(abasMobileUtils.exceptionMessage(e));
			er.setMessageLong(abasMobileUtils.exceptionMessageDetails(e));
		}
		return er;
	}
	
	@Override
	public ExecResult addOrder(String jsonData)
	{
		ExecResult er=new ExecResult();
		EDPEditor EDPEDIT=null;
		ArrayList<EDPMessage> edpMessages=new ArrayList<EDPMessage>();
		if(edpSessionService.EDPSESSION_START())
		{
			for(int i=0;i<1;i++)
			{
				if(edpSessionService.EDPSESSION_START())
				{
					try
					{
						// ^^^^^^^^
						try
						{
							if(EDPEDIT!=null&&EDPEDIT.isActive())
							{
								EDPEDIT.endEditCancel();
							}
						}
						catch(Exception rt)
						{
							EDPEDIT=null;
						}
						finally
						{
							if(EDPEDIT==null)
							{
								EDPEDIT=edpSessionService.SESSION.createEditor();
								EDPEDIT.resetErrorMessageListener();
								EDPEDIT.setErrorMessageListener(edpSessionService.edpMessageListener(edpMessages));
								EDPEDIT.setStatusMessageListener(edpSessionService.edpMessageListener(edpMessages));
							}
						}
						// ^^^^^^^^
						EDPEDIT=edpSessionService.SESSION.createEditor();
						EDPEDIT.beginEditCmd("(Infosystem)","WSERAKSIPARIS ow1");
						EDPEDIT.setFText("yerakdata",jsonData);
						EDPEDIT.setFieldVal("bstart","CLICK");
						er.setIsSuccess(abasMobileUtils.booleanValue(EDPEDIT.getFieldVal("yiserakscuccess")));
						er.setMessage(EDPEDIT.getFieldVal("yiserakmsg"));
						er.setMessageLong(EDPEDIT.getFieldVal("yiserakmsgdetail"));
						EDPEDIT.endEditCancel();
						
					}
					catch(Exception e)
					{
						e.printStackTrace();
						LOGGER.info(abasMobileUtils.exceptionMessage(e));
						LOGGER.debug(abasMobileUtils.exceptionMessageDetails(e));
						er.setIsSuccess(false);
						er.setMessage(abasMobileUtils.exceptionMessage(e));
						er.setMessageLong(abasMobileUtils.exceptionMessageDetails(e));
					}
				}
			}
			edpSessionService.EDPSESSION_END();
		}
		else
		{
			er.setIsSuccess(false);
			er.setMessage("Bağlantı Hatası");
			er.setMessageLong("Bağlantı Hatası ...");
		}
		return er;
	}
	
}
